x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第4章: 基礎暗号学講座 ～ 第3回 ～ ---

著者：IPUSIRON

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　前回はランダム置換・ランダム関数の概念について解説しました。今回はブロ
ック暗号の利用モードの解説とそれが情報理論的に安全かどうかを証明するとこ
ろまで解説したいと思います。ブロック暗号の利用モードは、ECBモード・CBCモ
ード・CFBモード・OFBモード・CTRモードがあります。しかしたくさん紹介しても
消化しきれないと思いますので、今回はECBモードとCTRモードについてだけ触れ
ることにします。なお、誤り伝搬（同期はずれ）やビット欠落・ビット破損とい
ったネットワークに依存するような話は今回はしないことにします。あくまで暗
号に関連する点に重点を入れる予定です。


■0x02.) 情報理論的安全性

　暗号の安全性を語るときは①アタッカー（アドバーサリーとも呼ぶ）の能力と
②どこまでの情報漏れを許容するかという2つの点に分けて考えます。
　まずアタッカーの能力としては無限の能力、有限の能力などがあります。後者
の有限の能力としては多項式時間・準指数的時間・指数的時間といったレベルで
考えられます。一般のコンピュータの能力は多項式時間の能力まで持っていると
議論されます。
　次にどこまでの情報漏れまでを許容するかということは、情報が完全に漏れた
らアウトなのか、情報の一部分（1ビットなど）さえも漏れたらアウトなのかとい
ったことです。

　細かい話は次回以降また解説しますので、まだわからなくても大丈夫です。こ
こでは、情報理論的安全性だけをしっかり理解しておいてください。
　情報理論的安全性では、理想的である計算時間（無限の能力を持つCPUと考えて
もらえればよい）と記憶領域（無限の領域を持つメモリと考えてもらえればよい）
の能力を持つアタッカーを考えます。こうしたアタッカーに対してさえも安全で
ある暗号のことが証明されたものを「情報理論的に安全」と呼びます。つまり、
「情報理論的に安全」ということは暗号における一番強力な安全性です。
　それに対して、アタッカーに無限の能力を考えない場合は、計算量的安全性と
呼ばれ、前述したようにアタッカーのレベルと許容するレベルの段階がいくつか
に分かれているので、それの組合わせ分だけ安全性が存在するということになります。

　それでは、共通鍵暗号系の情報理論的安全性を定義してみます。
　まず平文m、鍵kに対して、暗号文cが暗号化アルゴリズムであるEを用いて、次
のように表される共通鍵暗号系を考えます。

c=E(k,m)　←(1)

　また平文は集合M={m_1,m_2,…}から、ある確率分布によって生起すると仮定し、
~M（エムチルダ）によってその確率変数を表すとします。ただし、任意のm∈Mは
正の確率で生起すると仮定します。

　鍵は集合K={k_1,k_2,…}から、ある確率分布によって生起すると仮定し、~Kに
よってその確率変数を表すとします。

　そして、暗号文は(1)によって定まる集合C={c_1,c_2,…}上のある確率分布によ
って生起し、~Cによってその確率変数を表すとします。

　これで共通鍵暗号系の情報理論的安全性の定義の準備ができました。上記の記
号を使い、定義を表記することにします。

[定義]
∀c∈C、∀m∈M；Pr(~M=m|~C=c)=Pr(~M=m)
が成り立つとき、暗号系（~K,~M,~C）は情報理論的に安全（完全秘匿）であると
いう。

（図）http://akademeia.info/main/image9/jyouhou.jpg

　数学記号ばかりになってしまいましたが直観的にいうと、アタッカーが盗聴に
よって暗号文を入手したとするとき、平文を解読するための情報がなんら含まれ
ておらず役に立たないことを意味します。

　ただし、暗号が少しわかる人に言及しておくと、アタッカーはあくまで盗聴だ
けでありランダムオラクルモデルは使えないという仮定をしています。


■0x03.) 情報理論的安全性の例

　例えば、暗号化アルゴリズムD：c=m+kを考えてみます。
　また、M={0,…,9}とK={0,…,9}が各集合上でmとkが一様分布すると仮定します。

　このとき、Pr(~M=0)=Pr(~M=1)=…=Pr(~M=9)=1/10となります。

　ここでアタッカーが何らかの方法でc=1を入手したとします。これをDの式に代
入すると、1=m+kとなり、(m,k)の組み合わせは次の2通りのみになります。ここで
+はXOR演算（排他的論理和）であることを忘れないように。

(m,k)=(1,0),(0,1)

　つまり、c=1のときはm=2となることはありえません。
　よって、Pr(~M=2|~c=1)=0となり、Pr(~M=2|~c=1)≠Pr(~M=2)がわかります。

　ゆえに、このDの暗号系は情報理論的に安全でないことが示されました（反例が
ひとつ提示された）。


■0x04.) 情報理論的に安全な暗号系の鍵長と平文長の関係

[定理]
「情報理論的に安全」⇔「|K|≧|M|」

　この絶対値は、長さを意味します。例えば、100ビットの平文を暗号化したい場
合は、鍵の長さは100ビット以上必要ということです。

[証明]背理法を用います。

　|K|≧|M|でない、すなわち|K|＜|M|と仮定します。

　すると、ある平文m∈Mと暗号文c∈Cが存在して、次がいえます。

D_k(c)≠m　（∀k∈K）

　これは、Pr(~C=c|~M=m)=0であることを意味しますが、これは定義に矛盾します。

　ゆえに、|K|≧|M|となります。　（Q.E.D.）


■0x05.) ECBモード

　ブロック暗号の欠点はnビット以上使えないということです。利用モードとはブ
ロック長nのブロック暗号Eを用いて、nより長い平文M=(m_1,…,m_t)を暗号化する
ための技術です。
　ここで、|m_i|によってm_iの長さ（ビット長）を表すことにします。特に断ら
ない限り、|m_i|=n（ブロック長がn）とします。

　ECB（Electronic CodeBook：電子符号表）モードとは、次の仕様にしたがい各
m_iを単純に暗号化する方式です。

[1]暗号化

　平文M=(m_1,…,m_t)に対して、c_1=E_k(m_1),…,c_t=E_k(m_t)を計算して、暗
号文をC=(c_1,…,c_t)とします。

[2]復号

　暗号文C=(c_1,…,c_t)に対して、m_1=D_k(c_1),…,m_t=D_k(c_t)を計算して、
平文をM=(m_1,…,m_t)とします。

（図）http://akademeia.info/main/image9/ecb.jpg


　なお、最後の平文ブロックがブロック長に満たない場合には、パディングと呼
ばれるデータの詰め物を入れます。

　図を見てもらえればわかるように、m_i=m_jならc_i=c_jとなります。つまり平
文ブロックと暗号文ブロックが一対一対応の関係にあるわけです。これは安全性
の議論に直結します。
　直観的にも安全性に問題があることがわかります。例えば、平文の中に同じ値
を持つ平文ブロックが複数存在したとします。それらをブロック暗号のECBモード
で暗号化しますと、同じ値を持つ平文ブロックは同じ値の暗号文ブロックに変換
されてしまいます。これでは、暗号文全体を見るだけで、平文の中に同じ値の繰
り返しがあることが推測されてしまいます。というのも、本来は暗号化の結果は
あたかもランダム値に見えるのが理想的であり、同じビット長の繰り返しが何度
も登場する確率はほとんどありえないことです。それにもかかわらず登場してい
るということは、アタッカーは暗号文だけを見ただけでECBモードのような脆弱な
方式などを採用していると推測できるわけです。さらに何らかのきっかけで暗号
文の一部分が判明した場合、それがきっかけとして暗号解読が行われてしまう危
険性もあるわけです。

　前回のWBで解説したランダム関数・擬似ランダム関数の概念を使えば、次の図
のようにもう少し数学的・暗号学的に議論できます。

（図）http://akademeia.info/main/image9/ecb2.jpg

　アドバーサリー（アタッカーと同意）のAは適当にmを作ります。そして、m=m_1
=m_2として、ペア(m_1,m_2)を暗号アルゴリズムM_ecb(E_k)に送信します。ここで
M_ecbとはモードのMでECBを利用していることを明示する記号とします。そうする
と、暗号文のペア(c_1,c_2)が送られてきます。そのときM_ecb(E_k)が本当のラン
ダム関数ならばc_1=c_2になる確率はほとんどありません。しかしM_ecb(E_k)はE
CBモードの暗号化アルゴリズムなので、c_1=c_2となります。そうするとAはDが本
当のランダム関数でなく、擬似ランダム関数であると認識できます。つまり、暗
号化アルゴリズムが認識できたということはECBの暗号化は安全でないことになり
ます。


■0x06.) CTRモード

　CTR（CounTR：カウンタ）モードとは、次の仕様にしたがい各m_iを暗号化する
方式です。カウンタの役割を果たす変数ctrを利用します。

[1]暗号化

　平文M=(m_1,…,m_t)に対して、c_1=m_1+E_k(ctr+1),…,c_t=m_t+E_k(ctr+t)を
計算して、暗号文をC=(c_1,…,c_t)とします。

[2]復号

　暗号文C=(ctr,c_1,…,c_t)に対して、m_1=c_1+E_k(ctr+1),…,m_t=c_t+E_k(ctr+t)
を計算して、平文をM=(m_1,…,m_t)とします。ここで、DではなくEを使うことに
注意。

（図）http://akademeia.info/main/image9/ctr.jpg


　このCTRモードはECBモードから比べると若干複雑になっています。

　特徴としてまずブロックを任意の順番で暗号化・復号化できるということがい
えます。これはECBモードでも同様でした。この特徴は実際に暗号をプログラムと
して実装したときに各々の暗号化・復号の処理を並列処理させることができるこ
とを意味します。
　また、暗号化と復号はまったく同じ構造をしています。まして復号アルゴリズ
ムは必要なく暗号化アルゴリズムを復号処理でも利用しています。つまりプログ
ラムとして実装するときはわざわざ復号アルゴリズムに対応する関数などを用意
する必要がないということです。これは次回以降紹介するOFBモードと同じストリ
ーム暗号の特徴です。

　それではECBモードのときと同様に図で考えてみましょう。

（図）http://akademeia.info/main/image9/ctr2.jpg

　同じ平文のペア(m_1,m_2)をM_ctr(E_k)に投げてみます。すると暗号文(c_1,c_2)
が返ってきますが、CTRモードの仕様によりc_1≠c_2となります。これだけ見ても
ECBモードよりも安全性の意味で強くなっていることがわかります。
　実はAが2^nの計算能力があれば、CTRモードは安全でないことが証明されていま
す。しかしながら一般のコンピュータはそれほどの能力は持たないので（多項式
時間しか計算できないから当たり前）、CTRモードは推奨されています。


■0x07.) CTRモードと情報理論的な安全性について

　前回と今回のWBの内容がきちんと理解しているかどうかを確認するために、CT
Rモードについての問題を解いてみましょう。答えは伏せておきますので、自力で
解いてみてください。前回のWBで置換や関数の総数の計算方法をしっかり理解し
ておき、今回のWBで情報理論的な安全性の定義について理解しておけば、解ける
はずです。解答は質問掲示板の暗号関係スレッド（次のURL）でお待ちしておりま
す。また、ヒントが欲しいなども歓迎します。

http://ruffnex.oc.to/ipusiron/cgi/forum/patio.cgi?mode=view&no=1004

問：CTRモードについて、次の設問を解け。
（1）平文M=(m_1,m_2)に対する暗号文がC=(ctr,c_1,c_2)であった。このときの
E_k(ctr+1)およびE_k(ctr+2)の値を求めよ。
（2）ランダム関数族をブロック暗号として用いるCTRモードを考える。アタッカ
ーが暗号文C=(ctr,c_1,c_2)を入手した。このとき、平文が(m_1,m_2)である確率
を求めよ。
（3）ランダム関数族をブロック暗号として用いたCTRモードは、情報理論的に安
全であることを証明せよ。
（4）ランダム置換族をブロック暗号として用いるCTRモードを考える。アタッカ
ーが暗号文C=(ctr,c_1,c_2)を入手した。このとき、平文が(m_1,m_2)である確率
を求めよ。
（5）ランダム置換族をブロック暗号として用いたCTRモードは、情報理論的に安
全でないことを証明せよ。

■0x08.) おわりに

　今回はこれで終わりです。段々と数学的表記を用いているので難しく感じるか
たもいらっしゃるかもしれません。初学者向けの暗号本だと単に暗号の仕様（例
えばDESやAESの原理）だけを記述してあるものがあります。それはそれで大事で
すが、暗号を学問としてやる場合にはそれだけでは不十分です。仕様は単なる知
識であって、仕様から本当に安全かどうかを数学的に判断できる力こそが重要な
のです。その力は一朝一夕で身に付くものではありません。またそういう力を付
けるための暗号本も少ないのが実情です（あったとしても敷居が高い）。そうい
た状況を踏まえ、WBの皆さんには一歩ずつ着実にそういった力を身に付けてもら
いたいと思って、暗号講座を続けていきたいと思います。まだまだ続きそうです
が、諦めずに考えてみてください。考えて考えて考え抜いてください。それが遠
回りのように思えますが、実際は一番の近道なのです。

　それでは来月会いましょう。


