x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第3章: ハニーポットを作ろう（連載第6回） ---

著者：Narusase

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　前回は、honeydの起動方法とその基本的なオプションに関して説明しました。
そして、未使用のアドレスを監視させようとしてもうまく動作する場合と動作し
ない場合があるという問題が発生することを述べました。
　そこで、今回はその問題に対してどう対処するのかについて書いていきたいと
思います。


■0x02.) 問題のおさらい

　まずは前回のおさらいです。
　前回は192.168.1.3のIPアドレスについてhoneydで監視をしたところ、アクセス
に反応がない状態になりました。さて、この問題はなぜ起きたのでしょうか？

　実はこの問題はARPによるアドレスの解決ができないために起こった問題です。
元来、LAN内部にあるIPアドレスに対してアクセスする場合は対象のIPアドレスに
対応するMACアドレスを知っている必要があります。逆にLAN外部にアクセスする
場合は、ゲートウェイのMACアドレスを知っている必要があり、どちらの場合でも
IPアドレスとMACアドレスは切っても切れない関係にあります。

　しかし、honeydを動かしているPCは自分のIPアドレスやhoneydでEthernetに関
する設定がされているIPアドレスに対するARPのリクエストにしか反応しません。
このため、192.168.1.3に対するARPに何らかの手段で返答を返さなければ、通信
を行うことができません。そこで必要となるのがarpdです。


■0x03.) arpd

　arpdを簡単に説明すると、指定されたアドレスの範囲に対するARPリクエストを
受信し、ARPリクエストの送信先に対して自らもARPリクエストを送信します。そ
の後、ある一定時間待った後、自らが送信したARPリクエストに対する返答がない
場合、代わりにARPレスポンスを返答するものです。
　つまり、ARP Spoofingに似た手法を用いて特定のIPアドレスに対する通信を誘
導するためのソフトです。ARP Spoofingと異なる部分は、起動状態のIPアドレス
に対する通信を誘導しない点と、停止状態あるいは不在のIPアドレスに対する通
信を誘導する点です。
　したがって、arpdを用いることで個別にEthernetに関する設定がされていない
IPアドレスに対しての通信に反応しない問題を解決できます。

　ここで、Etherの設定をしてしまえばいいという考え方もありますが、LANの同
一セグメントから不正アクセスが起こるということは通常は多くないと考えられ
ます。そこで、わざわざhoneydにこれらのアドレスに対してMACアドレスを生成さ
せ、ARPなどに対して反応させるよりは、単にarpdを用いてひとつのMACアドレス
を教える方が効率的なのです。また、ひとつひとつMACアドレスを生成する場合は
起動中のIPアドレスに対する動的な監視は不可能です。そのため、動的な監視を
行うためにarpdが利用されます。


■0x04.) arpdの実行

　arpdのインストールは第4回で既に終わっているはずなので、インストールにつ
いては割愛します。また、特に設定などは必要有りませんので設定はとばして、
実行方法とオプションについて説明します。

　arpdを実行するには下記のようなコマンドを実行します。

------------
arpd -d -i eth0 192.168.1.3
------------

　-dオプションはデーモン化せずに実行することを意味します。また、このオプ
ションを付けた場合、詳細なデバッグメッセージが有効になります。よって、実
際の運用時には使用しないオプションで、どちらかといえば構築中のちょっとし
た実験や、バグの原因解明などのために使うオプションといえます。
　-iオプションはどのインターフェースで通信を待ち受けるかを指定します。複
数のインターフェースがある場合にどちらのインターフェースを監視するか指定
するためのものです。
　最後のIPアドレスはARPを返答するネットワークアドレスやホストアドレスを意
味します。実際にはホストアドレス（「192.168.1.1」という書式）に加えてネッ
トワーク単位（「192.168.1.1/24」という書式）、ある一定の範囲（「192.168.
1.10-192.168.1.20」という書式）が指定できます。

　arpdのオプションは以上です。


■0x05.) 再実験

　では、前回失敗した192.168.1.3へのポートスキャンをarpdを使って再度行って
みましょう。

　まず、設定ファイルから確認します。設定ファイル（「config.ethernet」ファ
イル）は次のようになっています。ただし、解説のために左に行番号を振ってい
ます。

------------
01 create default
02 set default default tcp action block
03 set default default udp action block
04 set default default icmp action open
05
06 create template
07 set template ethernet "3com"
08 set template personality "Linux 2.4.7 (X86)"
09
10 bind 192.168.1.2 template
11 bind 192.168.1.3 default
------------


■0x06.) honeydとarpdの実行

　コンソールまたはSSHの仮想コンソールを2つ用意し、それぞれ次のようなコマ
ンドを実行します。コンソール2で実行しているexportコマンドは必要な環境変数
の設定のために行っていますが、bashrcなどに登録しておいてもかまいません。

-----　コンソール1
honeyd -d -f config.ethernet -i eth0 -u 1000 -g 32767 192.168.1.1-192.168.1.2
-----

-----　コンソール2
export LD_LIBRARY_PATH=/usr/local/lib/
arpd -d -i eth0 192.168.1.3
-----

　実際に動作していることを確認するため、LAN内の他のマシンから192.168.1.3
に対してnmapを実行します。

　ここでは時間がかかるためポート1〜200まで限定してポートスキャンを実行し
ます。

-----
[root@localhost root]# nmap -sT 192.168.1.3 -p 1-200

Starting nmap 3.81 ( http://www.insecure.org/nmap/ ) at 2005-09-12 10:00 JST
All 200 scanned ports on 192.168.1.3 are: filtered
MAC Address: 00:04:5F:11:22:33 (Evalue Technology)

Nmap finished: 1 IP address (1 host up) scanned in 15.823 seconds
-----

　確かに192.168.1.3に対してアクセスができることが確認できました。また、ポ
ート1〜200までは何もサービスが起動していないことが解り、192.168.1.1と同じ
MACアドレスを持っていることが解ります。
　これで、問題は解決ですね（笑。


■0x07.) 発展

　さて、ここで問題を出題します。
　3台以上のPCを所持している方は設定ファイルの11行目のIPアドレスをハニーポ
ットでも、ポートスキャンを行うPCでもない、3台目のPCと同一のIPを指定してく
ださい。そして、honeydとarpdを起動して、3台目のPCが停止している状態と起動
している状態とで違いを確認してみてください。動的に監視ができていることが
わかると思います。

　「俺は実験しなくても頭の中だけで確認できる」とか「実験機材がないので確
認できない」という方はそれでもかまいません（笑。

　実際に、動的な監視ができていることが確認できたら、その手順を頭の中で追
うなり、Etherealでパケットを眺めるなどしてみて、なぜそうなるのかについて
説明してください。ARPの正しい知識が有ればきっと、「ああ！こうなってるのか
！」と納得できるはずです。

　解答については、次回に説明したいと思います。
　正解者には抽選で豪華特典をプレゼントしますので、住所、氏名、年齢をお書
きのうえ、下記のメールアドレスへどしどしご投稿ください。なお、正解者の発
表は本誌上にて行い、プレゼントの当選者は発送をもって発表に返させていただ
きます。

メールアドレス：narusase@mcn.ne.jp

…と書いたら、本当に送ってくれるのかな？


■0x08.) まとめ

　今回はarpdの実行方法とその原理に関して述べ、honeydと連携させることで動
的な監視が可能になることを説明しました。また、発展としてちょっとした問題
を出題してみました。
　次回は、問題の解答と、honeydのより詳しい使い方について説明していきたい
と思います。


