x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第○章: PHPでソケットを使ってサーバ負荷軽減 ---

著者：Zキチガイ

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　CGIを書こうとしたときは、まずどのプログラミング言語・スクリプト言語を使
うのかを選ぶ必要がある。その際に、PHPを選択する方も多いはずだ。なぜなら簡
単かつポピュラーであるからである。
　今回の記事では、そのPHPでソケットを使ってサーバーの負荷を軽くするような
スクリプトを書いてみようと思う。ソケットを使うといっても、メールを扱ったり
するわけではない。CGIスクリプトで使うソケットはサーバーと通信するためだけ
にある。なぜなら、ソケットはクライアントの接続を待つこともできるがCGIでそ
んなことはしないからだ。


■0x02.) CGIのソケットと負荷軽減の関係性

　今回CGIで使うソケットはどのサーバーと接続するのだろうか？
　例えば、ブラウザで有名掲示板2ちゃんねるの板を表示してみたとする。すると
ページのアドレスはindex.htmlとなっている。すなわちHTMLファイルだ。これは
どうしたことか。2ちゃんねるはCGIを使っていないのか。もちろんそんなわけが
ない。もしCGIを使っていないのなら書き込みができないからだ。表示にはHTML、
書き込みにはCGIと使い分けているのだ。

　さてこの辺りからが本題に入る。
　CGIでindex.htmlを生成するスクリプトを書くわけだが、いつindex.htmlを生成
するのだろうか。それは表示するデータが変更されたときである。つまり書き込
みがあったときに生成すればよいわけだ。

　掲示板のページにアクセスしたとき、基本的に誰でも同じものが表示されるよ
うに設計することが多い。CGIはクライアントが接続してくるたびにスクリプトを
実行する。だが、毎回同じものを出力していては、これは明らかにリソースの無
駄である。そこで最初の一回だけスクリプトを実行して結果を保存し、次からは
スクリプトを実行した結果（HTMLファイル）を返すようにすればよい。そうすれ
ば環境によるが負荷は大幅に減らすことができる。特にCGIとデータベースを連携
させているときは、データベースの負荷も軽くなる。

　CGIでHTMLを生成すれば負荷は軽くなることが理解できたはずだ。ではそのスク
リプトをどう書けばいいのか。ここで最初の疑問を思い返してほしい。ソケット
でどこのサーバーと接続するかという問いである。答えは自分自身、すなわちlo
calhostだ。
　掲示板を例にすると、書き込んだ直後に最初に自分自身で接続する。そして目
的のCGIで書かれたWebページを要求する。出力結果をHTMLファイルで保存する。
クライアントはhttp://*****/index.htmlか、http://*****/といったようにペー
ジを要求すればよい。
　このスクリプトを書くときにひとつ注意が必要だ。「test.phpからtest.phpの
ページを要求する」というようにしてはいけない。無限ループになってしまうか
らだ。


■0x03.) スクリプト

　まず、localhostの直下にtest.phpを作り、次のように書いて欲しい。

-----
<?
	phpinfo();
?>
-----

　そして、メインとなるスクリプトを次のようにする。

-----
<?
	$socket = fsockopen("localhost", 80);
	$request = "GET /test.php HTTP/1.0\r\n"
	. "\r\n";
	fwrite($socket, $request);

	while($s = fgets($socket)){
		$response .= $s;
	}

	echo $response;

	$fp = fopen("test.html", "w");
	fwrite($fp, $response);
?>
-----

　これを実行するとtest.phpのphpinfo関数の出力結果が入ったtest.htmlが生成
されているはずだ。


■0x04.) まとめ

　CGIからプログラムを習得した方はCGIでソケットやXMLを使ったことがない、ど
う使うのかわからないといった人もいるのではないだろうか。だがずっと使わな
いままではもったいない。PHPはとても使いやすくできている。PHPにソケットや
XMLの機能があるのは、他の高級言語の”たとえ使いにくい部分があろうともなん
でもできる”というためではなく、機能性・利便性のためだと私は考える。たと
え実務で使うことはなくとも、重箱の隅のような関数が大活躍する場面はあるの
だ。


