x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第○章: 美咲ちゃんの幻の14章はどうして本当に幻になってしまったのか ---

著者：やねうらお

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) この本は何なのか

　『解析魔法少女美咲ちゃんマジカルオープン』(秀和システム)は、ソフトウェ
アの解析手法についてライトノベル感覚で読めるようにわかりやすく書いた本だ。
ソフトウェアを解析してプロテクトを外したり、外されないように防御したりす
るためのノウハウを凝縮した。
　しかしこの本のタイトルでは内容を想像しがたいだろう。なぜこのようなタイ
トルになってしまったのか。私のblogより以下にその理由を引用する。

-----　blogから引用
　本というのは、企画案の段階で本のタイトルを決める。そのときの案では、美
咲は魔法使いで、「マジカルオープン！」とか言ってソフトをどんどんクラック
してしまう本になる予定だったのだ。

　美咲「でたわね！邪神ドングラー！あなたはソフトウェアにプロテクトをかけ、
罪もないバックアップ目的のコピーをもことごとく妨害し続けてきた！許せない。
罪のないコピーを虐げるだなんて！あなたの悪事の数々、この倉塚美咲がしかと
見届けたわよ！いでよ、逆アセンブラ！マジカルオ〜プン！！」

　とまあ、こんな本になる予定だった。それが少し書いてみたところ、すごく書
きにくいことに気づいた。２ページほど書いているうちに頭痛がしてきた。３ペ
ージほど書いているうちに吐き気がして、もう一行も書き進めなくなった。仕方
ないので、本のタイトルはあとで変更しようと思って、適当に書き進めた。締め
切りの日の前日なんか、1日で65ページも書いたりした。

　もう、魔法少女はやめて本のタイトルは「クラック読本」ぐらいにする予定だ
った。だって「解析少女美咲ちゃんマジカルオープン」って、何の本かすらわか
らんし。そんなわけで、書きあがった時に出版社の担当に相談したところ、

「企画案の段階なら変更できたんですけどねぇ．．」

　ガーーーン！Σ(゜Д゜)　だって本文に魔法とか全然出てないじゃないですか？

「魔法のようにクラックできちゃうってことでいいんじゃないですか？」

　そんなこんなで、締め切りに間に合わなくて、書きかけのままお蔵入りさせて
いた 14章以降を、やねう企画のホームページ上で公開しちゃいますよ！（書き上
げるまでしばらく待ってネ） そこでは美咲はついに魔法少女に．．。
-----

　ということだ。だから、締切に間に合わなかった14章の原稿を発売後に会社のペ
ージに載せようと考えていた。


■0x02.) 幻の14章はどうして本当に幻になってしまったのか

　実は原稿は締切に間に合わなかったのではない。“間に合わせなかった”のだ。
そのことを説明するために、この本を書くに至った動機を説明しておきたい。

　私は昔から他人のソースやプログラムを解析することが多かった。昔はそれほ
ど書籍やプログラミングの情報に恵まれておらず、他人のソースやバイナリの解
析ぐらいしか学ぶ手段がなかったからである。
　そこで、当然その過程でプロテクトルーチンにも接することになる。市販のソ
フトは解析をさせないために何らかの小細工がしてあることも多く、それらを解
析する過程で学んだことも多い。私はこういう経験がプロテクトを施す側にも必
要になると考えている。さもなくば仮にドングル(ハードウェアプロテクト)を自
社で作ったソフトに導入したいと考えたとしても、そのドングルのプロテクト強
度を自分で評価できないからである。

　さて、その問題の14章なのだが、ちょうどそれを書くとき、私は自社のソフト
のために製品WというS社のプロテクト装置の導入を検討していた。
　日本ではここをはじめとして数社しかドングルを販売しておらず、マニュアル
類が日本語で書かれているほうが使いやすいし、マイナーのドングルのほうが解
析情報が出回ってない可能性が高く、製品Wはアラジン社(世界的に有名なドング
ルの会社)のHASPより若干安かった。よってここを選んだわけである。
　そこで試しに10個この製品Wを購入して実際にプロテクトを掛けてテストしてみ
た。正確に言うと時間が無かったので自社製品の数個に製品Wでプロテクトをかけ
て出荷した。そして、そのあと自分でこのプロテクトの強度を調べてみることに
した。プロテクトの強度を調べるのに際してリバースエンジニアリングが必要に
なる。リバースエンジニアリングを行なって良いか、S社の社長であるK氏にメー
ルで確認した。

-----　K氏へのメール
それで、ひとつご相談なのですが、プロテクトの強度チェックに際して
その確認のためにリバースエンジニアリングが必要となる（こともある）
と思うのですが、それを行なっても構わないでしょうか？この部分、
お互い納得した状態で進めないと、あとでリバースエンジニアリングを
行なったことに対して御社からクレームがつくといけませんので、細心の
注意を払っておきたいのです。何卒宜しくお願い致します。
-----

　K氏からは以下の返答を得た。

-----　K氏からの返答メール
暗号化処理を行った貴社のプログラムに対して、リバースエンジニアリング等を
行って強度チェックを行って頂いても問題ありません。
過去、何度かハッカーコンテストを行っており、まだ破られたことがないのです
が....。
ただ、製品Wの暗号化ツール、ユーティリティにつきましては、開発会社と
の契約上、リバースエンジニアリング行為が禁止されていますので、できました
ら、ご遠慮いただけると有り難いのですが....。
-----

　そこでさっそく解析にとりかかった。
　すると驚くべきことにわずか数分でプロテクトは外れてしまった。この時点で
私の怒り爆発である。これは立派な詐欺商品だ！！うちの会社で作っていたソフ
トウェアに製品Wでプロテクトをして出荷した分はいまごろいまごろクラックされ
て使い放題に改ざんされていることは想像に難くなく、被害額も相当なものだ。
非常に遺憾である。

　そこでK氏にレポートのため以下のメールを出した。

-----　K氏へのメール
（･･･中略･･･）
仕組みとしては、製品Wと連動したバイナリの暗号化によるプロテクトです
ね。各社に固有のキーが割り振られるのですが、このキーを元に暗号化、復号化
が行われるようです。そのため、正規のドングル無しではクラックは不可能に等
しいです。（RSA コンテストに挑むようなもの）

ただ、これは製品Wに限らず、ドングルを採用しているどのようなプロテク
トでも考えられることですから、問題は「正規のドングルを所有していても、ク
ラックをすることが困難であるか」ということになります。

そこで調べていくと、この製品Wのプロテクト、非常に易しいです。
それこそ AsProtect の方が数段、ややこしいことをしています。

OllyDbg のようなフリーのデバッガーの SFX 解析で楽に OEP まで辿りつける上
に、その時点で、暗号化する前のセクションが、ご丁寧に元の IAT 等含め完全に
再現されています。この状態でぶっこ抜いて、PE ヘッダの一部（IAT に関するも
の、この時点では暗号化されたもののため）を、書き換えるだけで、プロテクト
が外れたバイナリを得ることが出来ます。

後は、製品Wの暗号化部が使用していたセクションを削り落す作業等をすれ
ば完了です。

開始、わずか数分程度でプロテクトが外れてしまいました。
（･･･中略･･･）
こんなものではプロテクトとは呼べないですし、AsProtectより脆弱なプロテクト
では商品的価値すら無く、正直、詐欺商品だと感じます。こんなプロテクトとも
呼べないような素人騙しの商品を売っていて恥ずかしくないのか非常に疑問です。
ひょっとしてK様は、この商品の技術的な仕組みをまったく理解されていないので
しょうか？

弊社の技術スタッフであれば、2,3日あればこれよりはるかにマシなプロテクトを
施すことが出来ます。しかしそれでは不安だからということで御社製品を買い求
めたのに、こんなプロテクトではAsProtectのほうがはるかにマシです。
-----

　K氏からはお詫びどころか返答のメールさえ来なかった。
　私がセキュリティ関連の商品を販売していたら、その商品のセキュリティ的な
欠陥は金を払ってでも教えてもらいたいところなのだが、K氏は違うようだ。まし
て今回の場合は私はこの商品を購入したお客様である。それと同時にこの商品の
セキュリティ的な欠陥により多額の被害を被った被害者である。その被害者が事
細かにこの製品の何がどう悪いか教えてくれるという五大陸に響き渡るような親
切心(大げさか)をもK氏は踏みにじるわけか。

　この仕打ちに怒り心頭に発した私はこの一件を美咲ちゃんの14章に書いてやろ
うと思っていた。
　しかし以上に書いたことはすべて事実であり、技術的にも何一つ間違ったこと
は書いていないつもりだが、この情報を公開することにより実際に製品Wの販売に
影響することは十分に考えられる。これを技術情報として本に書いてしまうと損
害賠償を求めて裁判でも起こされたら下手すると出版差し止めになりかねない。
　そこでホームページに掲載するのならば何か問題が起きたときに削除すること
により出版差し止めほどのダメージは無いと考えた。だから14章はホームページ
上で公開すると決めたわけだ。
　ところが美咲ちゃんの発売日になると気持ちが揺らいできたのだ。これは他社
製のドングルをいくつも調べてみた結果、プロテクト強度は若干違うものの似た
り寄ったりな状況だったので、製品Wだけが欠陥商品であるかのような書き方はい
かがなものか、と思うようになったためだ。

　何度でも書くが以上のように私から見て製品Wはドングルとしては欠陥商品そ
のものであるのだが、かと言って他のドングルが欠陥商品でないかのような書き
方は公平性に欠ける。私からすればほとんどの市販のドングルは欠陥商品であり
詐欺まがいの商品である。だから製品Wだけを槍玉に挙げ「他の商品なら安心だ」
とユーザーに錯覚させる行為はすべきではない。「どのドングルもあるレベルの
解析屋にとっては大差なく、クラックしようと思えばクラックできるのだ」とい
う現実をユーザーに知らしめることが先決だ。出来れば製品Wだけではなくすべて
のドングルを公平にその強度を比較したデータを公表すべきだろう。そう思って
いくつか資料を用意していたのだが、そのあと私はあるセキュリティ会社の取締
役に就任してしまった。それがせいで当時に私が作成した資料は門外不出になっ
てしまった。

　結局のところ、私は幻の14章をそのまま幻にしようと決めた。だけど何らかの
形で美咲本を買ってくれた読者にそのことを伝えようと思っていた。今回、こう
いう形で発表する場を提供してくださったIPUSIRONさんには感謝したい。


・『解析魔法少女美咲ちゃんマジカルオープン』をアマゾンで購入
http://www.amazon.co.jp/exec/obidos/ASIN/4798008532/aaaaab0c-22/


以上


