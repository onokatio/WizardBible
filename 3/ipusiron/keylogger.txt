x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

 --- 第２章：ハードウェア型キーロガーとログの解読 ---

 著者：IPUSIRON

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　「キーロガーを設置してパスワードを奪った犯人が逮捕」
　こういったニュースがちらほらと最近は見受けられます。彼らはたまたま捕まり
ましたが、実際にはたくさんのキーロガーが氾濫している実態を知っているでしょ
うか？ それを知ったら、「なぜ今更キーロガーなんて取り上げるんだ？ 」という
考えは一変してしまうと思います。

　今月号の記事では、キーロガーの仕組みはざっと簡単に取り上げ、その後、実際
の使われ方、うまくログを入手した次の段階の手法、そして最新のハードウェア型
キーロガーを紹介します。
　特に、ハードウェア型キーロガーによって、今まで比較的安全とされたものが簡
単に奪われてしまうことが明らかにされます。これは実験していた私もちょっとシ
ョッキングでした。ちょっと考えてみると明らかなんですが、意外と盲点だったよ
うです。

　いざ、次の項へ。


■0x02.) 今回用意したモノ

　今回、この記事を書くに当たって使用したハードウェア/ソフトウェアを列挙し
ます。あくまで記事を書くのに使っただけであり、読者の皆さんが実験する時には
この限りではありません。

●用意したハードウェア

・keykatcher
・Windowsと超漢字のデュアルブート可能なPC
・1CD Linux KNOPPIX

●用意したソフトウェア

・テキストエディタ
　Windowsでは秀丸、LinuxではKEdit、超漢字では基本文章編集を使いました。


■0x03.) キーロガーについての復習
　キーロガーとは、キーボードから入力した文字を記録していくプログラムです。
（ソフトウェア型）キーロガーの種類によっては、更新日時、マウス操作なども記
録できます。


■0x04.) ソフトウェア型キーロガーの概要

　ソフトウェア型キーロガーを分類すると、WindowsAPIをフックさせるタイプとキ
ーバッファを直接覗くタイプがあります。

○WindowsAPIをフックさせるタイプ
　これはちょっと分かりにくいかもしれません。簡単に言えば、Windowsを介して
間接的にキー入力を記録するタイプということです。これはアプリケーションの起
動やマウスの動き（右クリックや左クリック）も記録でき、全角のキー入力は全角
のまま記録できます。しかし、或るソフトウェアのアスタリスクでマスクされた部
分がログが取れない場合があります。ちなみに、私が実験したところ、MSNメッセ
ンジャーやWebページの認証のものは基本的に取れるようです。

○キーバッファを直接覗くタイプ
　これは前者のタイプでは記録できなかった入力など基本的に全ての入力が記録で
きます。しかし、半角で記録されるので、前者のタイプのように見やすいログには
なりません。 

　どちらも長所短所があるので、両方のタイプのキーロガーを設置するのが理想的
です。ただし、複数設置するとそのプログラムが動いているプロセス分だけ処理が
重くなります。

　本来はここで、ソフトウェア型キーロガーのインストール方法、操作方法を解説
しますが、本記事の一貫性が崩れてしまうので、省略します。
　詳細を知りたい方は、特別講座＜キーロガー編＞を参考にしてください。

http://akademeia.info/main/lecture3/tokubetu_keylogger.htm

　また、画像付きの解説が読みたい方は、『ハッカーの教科書』あるいは『コンピ
ュータ悪のマニュアル・ビギナーズ』を読んでみてください。


■0x05.)  ハードウェア型キーロガーkeykatcherの紹介

　keykatcherはhttp://www.keykatcher.comで購入できるハードウェア型キーロガ
ーです。ログ容量が32KBのモノが59ドル、64KBのモノが79ドルで購入できます。
　『コンピュータ悪のマニュアル　ビギナーズ』でもキーロガーの項で取り上げま
した。

　今回、実際に２つ購入したので（１つはMaDさんにあげた）、実験結果のレポー
トを発表します。


■0x06.) 接続方法

　keykatcherの取り付け方法は簡単です。

１：ターゲットPCのキーボードケーブルであるPS/2プラグを抜きます。

２：その間にkeykatcherを接続します。

３：これで完了です。簡単ですね。メモリをマザーボードに挿すより、はるかに簡
単です。


■0x07.) keykatcherの操作方法（メインメニュー）

１：keykatcherを使うために、まず最初にテキストエディタを開きます。

２：次に、初期パスワードは「keykatcher」なので、それをテキストエディタ上で
入力します。

３：すると、次のようなメニューが表示されます。

-----
keykatcher 64K 3.7
064859 bytes free
1-View Memory
2-Erase Memory
3-Change Password
4-Disable recording
5-NETPatrol Output
6-Search for String
7-Exit
-----

　１行目はキーロガーのバージョンとタイプを示します。

　２行目ではまだ記録できる容量が示されます。この例では64,859バイト残ってい
ることを意味します。

　出力結果の３行目以降がメニューです。
　１がログ表示、２がログクリア、３がパスワード変更、４がログ記録停止、５が
wwwを含む行周辺、すなわちURLらしき文字列を含む行周辺の列挙、６が特定のキー
ワードを含む行周辺の列挙、７がメニューを抜け出しです。


■0x08.) keykatcherが記録できるモノ

　keykatcherのログを表示させれば（メニューの１番）分かりますが、基本的に全
て半角英数記号で記録されます。そして、バックスペース、改行、スペースも記録
されます。ただし、[Ctrl]キー操作は記録されません。シンプルなので、特定の目
的に使う場合に向き、余分なログを残さないという点では評価できます。

　ソフトウェア型キーロガーではないのでもちろんマウス操作、ウィンドウ操作な
どはログとして残りません。ソフトウェア型キーロガーにも複数の種類が存在しま
すが、キーバッファをキャプチャーするタイプに近いです。


■0x09.) ハードウェア型キーロガーの大きな特徴

　ハードウェア型キーロガーはソフトウェア型キーロガーに比べて有利な点がいく
つかあります。どんな点において有利であるかをここで紹介します。

○BIOSのパスワードを取得
　BIOSのパスワードクラッキングは、ソフトウェア型のキーロガーでは難しいです
が、ハードウェア型のキーロガーだったら簡単にキャプチャーできます。

○ログインパスワードを取得
　電源投入後、システムが立ち上がり、ログイン（ログオン）の認証が始まります
が、この認証時には基本的にソフトウェア型キーロガーは立ち上がっていない状態
なのでキャプチャーできません。
　しかし、ハードウェア型のキーロガーだったら簡単にキャプチャーできます。

○ログ回収が楽
　仮にネットカフェに設置したとします。１回設置したら、後日keykatcher本体を
回収しにいくのではなく、利用客を装い、普通にキーロガーのパスワードを入力し
管理メニューを開きログだけを他のファイルに保存し、ログを消去しておけば、半
永久的に活用できます。

○OSに依存しない
　直接キー入力を記録しているので、OSに依存しません。これはソフトウェア型キ
ーロガーには不可能な大きな特徴です。例えば、Linuxのテキストエディタを開いて、
パスワードを入力すれば、ちゃんとメニューが表示されます。実際に、Windows,L
inux,超漢字で実験したところうまくいきました。

　超漢字の世界にはまだキーロガーはありません（聞いたことがない）が、これで
根底から覆ることが分かります。

○無線との連携でログ回収は遠隔で行える
　ログを自動で無線送信するように改造できれば、わざわざ設置マシンの前に座る
ことなくログを記録できます。
　これは追跡を逃れる手としては非常に有効です。
　ただし、コストの面と比較して得かどうかを天秤にかける必要はあるでしょう。


　一方、ハードウェア型キーロガー故の欠点もあります。

○ネット経由でリモートからログ回収が不可能
　設置箇所がHDの中ではなく、キーボードとマシンの間にあるわけなので、リモー
トから通常は管理メニューを表示させることはできません。

○コストがかかる
　ソフトウェア型キーロガーの場合、何百台に設置しようが根本的にお金はかかり
ません（キーロガーのシェア料金などは計算しない）。
　しかし、ハードウェア型キーロガーの場合、設置する台数分だけコストがかさみ
ます。よって、多くのマシンに設置する場合は、自作するほうが低コストで収まる
と思います。

○ログ表示に時間がかかる
　全部のログをテキストファイルに保存したい場合、メニュー１で新規テキストフ
ァイルにログを全表示してそれを保存する必要があります。これがいちいち表示さ
れていくわけなのでログが膨大だと結構時間がかかります。
　さらに、このログ表示時は他の作業が行えません。なぜならば、他の作業をしよ
うと、他のテキストファイルのウィンドウをアクティブにすると、そこにカーソル
が写ってしまうので、そこにキーロガーのログが表示されてしまうからです。


■0x10.) ログの読み方

　キーロガーの解説、設置方法などを解説している本はたくさんありますが、ログ
の解読方法といったことまで解説した本は少ないように感じます。これからは手口
やテクニックだけではなく、実際に実験した結果分かることやそれ故の苦悩などを
解説していきたいと思っています。

　では、本題に移ります。

　次のログは、この原稿を書きながらキャプチャーしたキーログのほんの一部です。

-----
maru 
OS
ni
izonnsinai 

 W<BS>tyokusetu 
ki-nyuuryokuwo 
kirokusiteirunode ,
sofutouxea 
<BS><BS><BS><BS><BS><BS>OS
ni
izonnsimasenn .
-----

　どんな意味か分かりますか？　英語ではなく、ローマ字のようなので日本語だと
分かります。<BS>はバックスペースを意味します。そして、改行が多用されていま
すが、これはかな変換を確定するために[Enter]キーを入力しているからです。
　また、半角・全角切り替えの[漢字]キー、Windowsメニューを表示する旗マーク
のキー、[PageUp]/[PageDown]キー、[NumsLock]キー、[PrintScreen]キー、矢印キ
ーもログに残りません。
　ただし、かな変換において、候補漢字を探すための[変換]キーあるいは[スペー
ス]キーはログとして残ります。スペースの数で何回変換のためにスペースキーを
入力したのかをカウントできます。

　このログを翻訳すると次のようになります。しかしながら、どの漢字を選択して
いるのかは分からないので、文意から推測することになります。また、マウス操作
によるマウスカーソル移動の可能性も考えられるので、それも考慮しておきます。

-----
●[変換][確定]OS[変換][確定]に[改行]依存しない[変換][確定]
[改行]
　W[BS]直接[変換][確定]キー入力を[変換][確定]記録しているので[変換][確定]、そのソフトウェア[変換][確定][BS][BS][BS][BS][BS][BS]OS[確定]に[確定]依存しません[変換][確定]。
-----

　本当に入力したテキストは次の通りです。

-----
○OSに依存しない
　直接キー入力を記録しているので、OSに依存しません。
-----

　かな変換の記号の違いなどありますが、いい線いっていることが分かります。実
際に手を動かしてみると、結構ログの解読は面倒であることが分かると思います。
　手動でやるのも重要ですが、行数が多くなると大変なので、現在、自動的に翻訳
作業を行うプログラムを作成中です。完成したらサイトで公開します。

　以上でログから内容を翻訳する基本的作業は分かったと思います。


　しかし、これで終わりではありません。今回のログが数行だけだったので楽でし
たが、これが数万行だったらどうしますか？　その中から果たしてパスワードとい
ったクリティカル（致命的な）情報を取得することができるでしょうか。このよう
な問題に対するアプローチを例としてまとめてみました。

例１：目的の文字列を探すのは簡単ですが、目的の文字列が不明でそれを探すとき
は経験が必要です。具体的に言えば、ターゲットのパスワードを入手したいとしま
す。通常パスワードの文字列自体を知らないので、メニュー６で検索することが不
可能です。よって、前後の流れからパスワードやIDだと思われるところを推測する
ことが必要です。

　ID部分がアットマーク（「@」）を含むのならば、メニュー６で「@」を指定して
検索すればよいので簡単です。その直後に来る文字列がパスワードの可能性が高い
と分かります。これはMSNメッセンジャーやYahooメッセンジャーといったメールア
ドレスをアカウントIDとして採用しているところを攻略するには有効な手です。

-----
keykatcher 64K 3.7
063161 bytes free
1-View Memory
2-Erase Memory
3-Change Password
4-Disable recording
5-NETPatrol Output
6-Search for String
7-Exit

6
Enter Search String)6-10 chars+@　←「@[Enter]」を入力。

Searching-Please Be Patient..　←文字列検索開始。
)@ nna  <BS>ga ki-wa-do  <BS><BS><BS><BS><BS>@] [ attoma-ku ( ) wo <BS><BS><BS><BS>
)@ <BS><BS><BS><BS>menyu- 5 <BS>6 de a<BS>[] @wo siteisite kennsakusure
)@ <BS><BS>1: <BS> s  pus<BS><BS><BS>ipusiron@ruffnex.oc.to hogehoge  
-----

　このログから最後の「ipusiron@ruffnex.oc.to hogehoge」部分が怪しいです。
文字列検索の結果は通常のログの出力とは少し異なります。本来のログは
「ipusiron@ruffnex.oc.to[Enter]hogehoge」であって、
「ipusiron@ruffnex.oc.to」直後の空白は本当は無いのに追加されていることがわ
かります。

例２：キーロガーでキャプチャーされていることを前提とします。パスワードには
長い無意味な特殊文字を含む文字列を選ぶようにとたびたび言われています。しか
し、キーロガーを使うアタッカーから見れば、その対処方法は一番最悪であること
が判明します。あなたがアタッカーだと仮定して、キーロガーのログをチェックし
ているとします。そのとき、明らかに文書にならないような文字列があり、さらに
長くて、特殊文字を含んでいたら、これはパスワードだと気づくでしょう。よって、
キーロガーを使用するアタッカーから見れば、日本語に近いパスワードの方が、逆
にパスワードだと気づきにくいわけです。とはいえ、あまりにも簡単な日本語の挨
拶のような文章、あるいは単語にしてしまうと、ディクショナリーアタック（辞書
式アタック）で突破される可能性が高いので、注意してください。

例３：今年キーロガーを使い、不正に取得したネットバンクのパスワードを悪用し、
１千数百万を不正送金した事件がありました。この事件でネットカフェでネットバ
ンクを使うのは危険であるというコメントをした人が多かったですが、本質的な部
分はそんなところにはありません。ネットカフェだろうが社内だろうがどこでも危
険ですので、こんなことは当然のことであって本質とは言いがたいと思われます。
それではどこに事件の本質があったのでしょうか。結論を言ってしまえば、ネット
バンクの認証システムです。ネットバンクの大手のジャパンネットバンク（JNB）
の場合、パスワード認証でログイン後、送金時には対応表を使ったもうワンクッシ
ョン置いた認証があります。今回の事件はシティバンクがターゲットだったわけで
すが、シティバンクには対応表を使った認証がなく、静的なIDとパスワードのみの
アカウントだけで送金まで行えたのが問題だったのです。
　この事件の被害者がネットカフェでジャパンネットバンクのアカウントを利用し
たと仮定します。それならば、キーロガーが設置してあったとしても、おそらく不
正送金はされなかったでしょう。キーロガー設置者がジャパンネットバンクのアカ
ウントは取得できたとしても、対応表の方が突破できないと思われます。対応表の
数字はHTTP（HTTPS）で送られてくるわけなので、どうしてもキーロガーだけの力
では解析が不可能です。トロイの木馬やSniffer盗聴、ショルダーハッキングなど
を併用しなければ、対応表の求められている数字に対応する変換前数字（変換元数
字）がアタッカーに分かることはないからです。


■0x11.) キーロガーからの防衛

●ソフトウェア型キーロガーからの防衛

・ウイルススキャンソフトウェアの導入
　キーロガーはウイルスやトロイの木馬に仕込まれている場合があります。このよ
うなキーロガーはウイルススキャンソフトウェアで見つけることができる可能性が
あります。 

　しかし、ここで紹介したIKS v1.2のように意図的にインストールしたキーロガー
は普通のプログラムと同じ扱いを受けるために、ウイルススキャンソフトウェアで
見つけることができません。 

・専用スキャンツールの導入
　そこで、Anti-keylogger（http://www.anti-keyloggers.com/：antikey.zip）と
いうキーロガー発見ソフトウェアを利用することで、もしキーロガーが仕掛けられ
ていても気づくことができます。ちなみに、このAnti-keyloggerはシェアウェアで、
登録前はキーロガー本体の削除はできないが、キーロガーの存在はきちんと認識で
きます。59.95ドルでオンライン販売されています。心配な人は一度試してみて、
もし見つかったら購入を検討してみてはどうでしょうか？ 

・手動による監視
　ウイルスやトロイの木馬に仕込まれているキーロガーは、キー入力の情報を記録
していることを示すものが何もないことが多い。タスクトレイにアイコンがあるわ
けでもないし、場合によっては［Ctrl］＋［Alt］＋［Delete］キーを押したときに
表示される実行中のプロセス表示の一覧にもないことがある（これをステルス機能
と呼びます）。普通の人は全く気付かずにキー入力をし続け、大事なIDやパスワー
ド情報などが送信されてしまうのだ。 

・ポート監視ツール
　メール送信を行うキーロガーだけに効果があります。メールを送信しようとする
時に、キーロガーがネットワーク通信のためにソケットを作ります。そのとき、イ
ンターネット側のSMTPサーバーに接続するわけですが、キーロガー側がクライアン
トとなりポートが開きます。クライアント用なので、1024〜65535のいずれかのポー
トが絶対に開きます。ただし、メール送信の度に使用するポート番号は動的に変化
します。
　この瞬間を見逃さないようにポート監視ツールで常に見張っておくという手も考
えられます。

　Snifferでネットワークのパケットログを監視しても、代用できます。


●ハードウェア型キーロガーからの防衛

・コネクタ周辺のチェック
　keykatcherの場合、PCの背面にあるキーボード用のPS/2に接続されます。よって、
定期的に背面をチェックしておけば一度見たことある人は明らかに分かります。
　しかし、最近は巧妙化しており、キーボードそのものに内蔵されているタイプも
発売されています。
　よって、改造マニアの人ならば、普通に市販されている普通のキーボードにそう
いう仕掛けを施したり、マザーボードに直接はんだ付けすることもできるでしょう。

・USBキーボードを使う
　現在発売されている主流のキーロガーはPS/2に接続するタイプのものなので、U
SBキーボードを使用することで素人アタッカーから防衛することはできます。
　しかし、この防衛方法は消極的なものです。というのも、前述したように、直接
マザーボードなどに仕込まれたり、USBタイプのモノを開発されれば、この防衛方
法はあまり意味がないということになります。

・設置不可能な状況を作る
　ケースを開けることができないようにカギをしたり、背面にはアクセスできない
ようにします。それでも、アタッカーは何らかの盲点をついてハードウェア型キー
ロガーを設置する可能性があります。
　そこで、PCの設置してある部屋にはカギを閉め、ビデオカメラで監視するという、
設置されたとしてもそれを察知する機能を備えておくことが有効です。この方法が
今考えられる防衛方法の中で一番効果的だと思います。


■0x12.) 物事をより知るためのアプローチと脳の各部位に訴えかける文

　物事をより知るためのアプローチは理屈を追っていくという方法があります。つ
まり、理屈の理屈の理屈の…状態に理解するアプローチです。
　例えば、PCの仕組みを完璧に極めることだけに限定したとしても、次のように多
くの事柄を含んでいることが分かります。

○PCの操作方法
→ハードウェアデバイスの制御のためのプログラム
→各電子回路でのデジタルデータのやり取り
→CPUやハードウェアの電子回路の仕組み
→電子部品の性質
→電子部品の実現化の理屈（化学や物理）
→PCのモデルとなったチューリングマシン
→離散数学（⊂応用数学）
→通常の数学（⊃素朴的集合論）
→基礎数学（公理的集合論）

　今回、この記事で採用したアプローチは逆のものです。つまり、ある程度の理屈
で打ち止めして、それの応用の応用の応用の…状態に理解するアプローチです。
　例えば、上記と同様にPCの仕組みからスタートすると、次のようになります。

○PCの操作方法
→ソフトウェアの導入
→ソフトウェアの操作方法
→ソフトウェアを実際に使ったときのテクニックやトラブルシューティング
→ソフトウェアの応用

　もちろん、途中で矢印が枝分かれになることも多々ありますが、この例でイメー
ジは掴めたと思います。

　前者、後者どちらのアプローチもケースバイケースなのですが、特に実践力を重
視した場合、後者のアプローチが有利に働きます。さらに、前者はすでに過去にあ
るものを学ぶということが主体になり、後者はいずれ新しいものを作る・考えると
いうことが主体になります。この点も見逃せません。
　人によっても学習方法のアプローチは異なります。どちらが絶対などありません。
今まで前者のアプローチで文を書いてきましたが、今回はちょっと趣向を変えて後
者のアプローチで書いてみました。


　また、単に右脳・左脳に訴えかける情報だけでなく、右脳と左脳を繋いで左右の
脳の情報交換する脳梁【ノウリョウ】の役目に対応する情報、さらには本能やセン
スを司る視床下部である扁桃体【ヘントウタイ】に訴えかけるような情報を示して
いきたいと思っています（あくまで比喩の話しなので注意してください）。
　人間は、自転車を運転する時、頭で考えずに自然に体重移動で左右に移動してバ
ランスをとります。また、野球のピッチャーがボールを投げて、それを動体視力で
視覚化し、脳で考える前に自然とバットが出て、最終的にホームランを放ちます。
いずれの例が成功するのも扁桃体がうまく機能しているからです。
　理屈を述べた文章は左脳、イラストは右脳、文章が上手い人の文は脳梁に訴えか
けます。しかし、なかなか扁桃体に訴えかけるような文に出会えません。そもそも
そんな文を書くこと自体が可能かどうかも分かりません。可能かどうか分からない
ものがあったら、とりあえず挑戦しておくという信条に則り、これから精進してい
きたいと思います。


　このような点を意識しながら、本文を読んでもらえると、文意をよく理解するこ
とだけでなく、自分のアプローチを見直すのにも役に立つと思います。


■0x13.) まとめ

　どうでしたでしょうか？
　「キーロガーなんて誰でも設置できる」「キーロガーなんて低スキルのやること
だ」なんて思っていた人でも、キーロガーひとつとっても意外に奥が深いこと、解
読テクニックは新鮮だったことだと思えたのではないでしょうか。

　では、vol.4でまた会いましょう。


