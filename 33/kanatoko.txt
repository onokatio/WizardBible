x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第○章: DNSを使った攻撃 ---

著者：金床

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　Anti-DNS Pinningについて某所でプレゼンなどをやらせてもらってきたが、こ
こに来てやっと用語の整理ができてきたので、簡単にまとめてみたい。今になっ
てプレゼン資料を見てみると「オイ違うだろソレ」という点が出てくるのでまっ
たく困ったものである。
　ということで、「Anti-DNS Pinning」でググると上位に出てくるあの資料は参
考程度扱いでお願いします。プレゼンをきいてくれたみなさんｽﾐﾏｾﾝ(;´Д`)ｱｾｱｾ


■0x02.) DNS Spoofing

　つまり最終的に行われる攻撃は「Anti-DNS Pinning」ではなく「DNS Spoofing」
なのである。
　…といきなり書いても意味がわからないと思うので、簡単に説明する。

　まず、本稿中でのみ使用する「プログラム」というオレ用語を定義しておく。
「プログラム」とは

・JavaScript
・FLASH
・Javaアプレット
・LiveConnect（のJava）

　などの、一般的なウェブブラウザが備えている「ネットワークアクセス能力を
持つ」機能のことである。これらはイヴ（攻撃者のこと）のウェブページに含ま
れており、罠のページを踏んでしまったあわれなアリス（ターゲットのユーザの
こと）のウェブブラウザ上で稼働する。

　プログラムが持つネットワークアクセス機能には、それぞれにセキュリティ制
限が備わっている。この制限は「Same Origin Policy」とよばれる。
　JavaScriptの場合には同じドメインに所属するページの内容しか読めない（他
のドメインのページを開くことはできる）。また、XHRはダウンロード元のホスト
にしか接続できない。
　FLASHのSocketクラスはダウンロード元のホストにしか接続できない（特殊な設
定によって明示的に許可している他のホストには接続できる）。
　JavaアプレットやLiveConnectのJavaはダウンロード元のホストにしか接続でき
ない。

　このような制限がなければ、アリスのウェブブラウザを踏み台にイントラネッ
トをスキャンしたり、スパムメールを送信したり、Exploitコードを打ち込んだり、
他のサイトにDoS攻撃を仕掛けたり、とやりたい放題になってしまうのだ。
　しかし「セキュリティ=いたちごっこ」の定理にしたがい、この制限を突破する
手法が考え出されたのである。それがDNS Spoofingだ。


■0x03.) DNS Spoofing

　ちなみにDNSを悪用する攻撃には色々な種類が存在し、そのうちいくつかは「D
NS Spoofing」と呼ばれる。つまり「DNS Spoofing」という用語は複数の意味を持
つので、その点についてはご了承願いたい。「オレが知っているDNS Spoofingは
そんなヤツじゃなかった」とか言わないように。

　プログラムに対するDNS Spoofingは、だいたい次のようなイメージで行われる。
某プレゼン資料より引用する。

・ まず罠のページが読み込まれる
・ このとき名前解決が行われる
・ 短いTTL(数秒)を持つDNSレコードを返す
・ 少し経ってからプログラムがダウンロード元のホストへ接続を試みる
・ 2度目の名前解決が行われる
・ 攻撃者のDNSサーバーは偽のIPアドレス(127.0.0.1 192.168.0.1など)を返す
・ 同一のホスト名なので接続は許可される
・ (;´Д`)ｴｰ

　このように、イヴが持つドメインはイヴがDNSサーバーを自由に操ることができ
るため、ウェブアプリケーションと連動して設定を変更することでSame Origin 
Policyが破られてしまうのである。この攻撃をDNS Spoofingと呼ぶ。


■0x04.) 最新の攻撃手法?

　さてあなたは0x03で述べた攻撃（DNS Spoofing）を知っていただろうか。筆者
はつい5ヶ月くらい前（2006年末）まで知らなかった。あまり話題にならなかった
気がするので、「ｺﾚ、最新の攻撃手法でしょ？」と考えてしまうかもしれない。
だがしかし…

http://www.cs.princeton.edu/sip/news/sun-02-22-96.html

　この記事を読んで欲しい。驚くべきことに、なんと1996年に書かれたものなの
だ！
　細かい点で若干異なる点がある（短いTTLを使うわけではなく、最初から2つの
IPアドレスを返してしまうようだ）が、基本的なコンセプトはまるで同じである。
1996年、つまり11年前である。筆者が最初のコンピュータを買ったのは1997年だ
ったように記憶しているので、何というかとてつもない昔のことのように感じて
しまう。

　この記事はSunのJavaアプレットの実装について述べたもので、どうやら某プレ
ゼン資料に「Sunのエンジニアはこの攻撃を予期していた！」とか書いてあるのは
真っ赤なウソだったようである。JVMが超頑固にキャッシュをPinningするのはこ
のように指摘されたせいであったようだ。

　筆者がこの攻撃を「DNS Spoofing」とよぶことにした大きな理由のひとつはこ
の記事でそのようによばれているからである（また、用語の使われ方も納得がい
くからだ）。


■0x05.) DNS Pinning

　ということで、この攻撃は11年前から知られていたのである。そして、Sunはこ
の脆弱性（?）に対してきちんと対応を行った。その方法は「一度名前解決したら、
その結果を（JVMの起動中は）永遠にキャッシュする」という極端なものである。
このように名前解決した結果を（DNSプロトコルのTTLを無視して）アプリケーシ
ョンが独自にキャッシュしておくことを「DNS Pinning」とよぶ。この用語はMoz
illaの開発者の間などで使われるようになったようだ。

　つまり「DNS Pinning = Anti-DNS Spoofing」なのである。…ﾅﾙﾎﾄﾞ(ﾟдﾟ) !


■0x06.) Anti-DNS Pinning

　DNS Pinningの実装にはいくつかパターンがある。先述したようにJVMはこの中
でも最右翼の「一度名前解決したらそれを永遠にキャッシュする」という実装を
選んでいる。一度決めたら2度と言うことを変えない、超ｶﾞﾝｺ親父を想像してもら
うとよいだろう。
　一方でIEやFirefox、Operaなどの主要ブラウザは「DNS Pinningするが、アクセ
スが失敗するようだったら再度名前解決する」という実装を選んでいる。これは
ダイナミックDNSによって運営されているウェブサイトなどを強く意識しているも
のと思われる。そしてこの事実によってDNS Spoofing攻撃が可能になるのでは、
とセキュリティコミュニティに伝えたのがﾏｰﾃｨｿであり、彼はウェブサーバーを停
止するかファイアウォールでアクセスをブロックすることで2度目の名前解決が発
生する事実を突き止めたのである（といっても、おそらくウェブブラウザの開発
者に言わせれば「それは仕様です」ということになると思われる）。

　このようにDNS Pinningの状態を破ることが「Anti-DNS Pinning」なのである。

　実際の攻撃の際には、Anti-DNS Pinningによって2度目の名前解決を行わせ、結
果としてDNS Spoofing攻撃が行われることになるのである。

　…ﾅﾙﾎﾄﾞ(ﾟдﾟ) !!!


■0x07.) FLASH

　Adobeは（というかマクロメディアは）あまりやる気がないというか単に知らな
かっただけなのか、DNS Pinningを一切行わない。つまり11年前の手法で普通にD
NS Spoofingできる。しかしこれは必ずしもFLASHの脆弱性ではなく、DNSプロトコ
ルそのものの問題という意見もあるだろう。ちなみに筆者はこれはDNSプロトコル
の問題だと考えている。


■0x08.) まとめ

　年末からしばらくAnti-DNS Pinningネタのデモ制作などに明け暮れていたのだ
が、最初にウェブブラウザを調べ、その後Javaを調べ、最後にFLASHを調べたせい
で、用語について混乱してしまっていた。実際にはもっとも原始的なのがFLASHで、
ウェブブラウザやJavaアプレットなどは一歩先の対策を行っていたのである。筆
者が先述した1996年の記事をしらなかったことが混乱の最大の原因なのだが…。

　ということで、ここでの簡単なまとめは

・DNS Spoofingは11年前からある攻撃だが、FLASHには今の時点でも有効
・DNS Pinningはその対策であり、ウェブブラウザやJavaアプレットが実装してい
る
・Anti-DNS Pinningは最新の攻撃手法であり、DNS Pinningを破る可能性がある

　ということになる。現在執筆中の某書籍にてさらに詳しく説明を行っているの
で、楽しみにして頂きたい。



